name: CI/CD

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ] # Simplify tag pattern to catch any v... tag
  pull_request:
    branches: [ "main", "develop" ]
  workflow_dispatch: # Allow manual trigger

jobs:
  test:
    name: Test & Analyze
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      - name: Install dependencies
        run: flutter pub get

      - name: Analyze code
        run: flutter analyze

      - name: Run tests
        run: flutter test

  version-check:
    name: Check Version (On Main)
    needs: test
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check for new version
        run: |
          PACKAGE_NAME=$(grep 'name:' pubspec.yaml | sed 's/name: //')
          LOCAL_VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //')
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://pub.dev/api/packages/$PACKAGE_NAME)
          
          if [ "$HTTP_CODE" == "404" ]; then
             echo "Package not found. Ready to publish first version: v$LOCAL_VERSION"
          else
             REMOTE_VERSION=$(curl -s https://pub.dev/api/packages/$PACKAGE_NAME | grep -o '"latest":{"version":"[^"]*"' | cut -d'"' -f6)
             if [ "$LOCAL_VERSION" == "$REMOTE_VERSION" ]; then
                echo "Version matches pub.dev. No need to recreate tag unless retrying."
             else
                echo "Local version ($LOCAL_VERSION) > Remote ($REMOTE_VERSION)."
             fi
          fi

  publish:
    name: Publish to pub.dev
    needs: test
    # Run if it's a tag push OR if manually triggered (workflow_dispatch)
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      id-token: write 
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Publish to pub.dev
        run: dart pub publish -f
