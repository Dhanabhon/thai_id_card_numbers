name: CI/CD

on:
  push:
    branches: [ "main" ]
    tags: [ "v[0-9]+.[0-9]+.[0-9]+*" ] # Trigger on tags like v1.5.0
  pull_request:
    branches: [ "main", "develop" ]

jobs:
  test:
    name: Test & Analyze
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      - name: Install dependencies
        run: flutter pub get

      - name: Analyze code
        run: flutter analyze

      - name: Run tests
        run: flutter test

  version-check:
    name: Check Version (On Main)
    needs: test
    if: github.ref == 'refs/heads/main' # Only run on main branch
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check for new version
        run: |
          PACKAGE_NAME=$(grep 'name:' pubspec.yaml | sed 's/name: //')
          LOCAL_VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //')
          
          # Check pub.dev
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://pub.dev/api/packages/$PACKAGE_NAME)
          
          if [ "$HTTP_CODE" == "404" ]; then
             echo "Package not found. Ready to publish first version: v$LOCAL_VERSION"
          else
             REMOTE_VERSION=$(curl -s https://pub.dev/api/packages/$PACKAGE_NAME | grep -o '"latest":{"version":"[^"]*"' | cut -d'"' -f6)
             if [ "$LOCAL_VERSION" == "$REMOTE_VERSION" ]; then
                echo "Version $LOCAL_VERSION matches pub.dev. No action needed."
             else
                echo "::notice title=New Version Detected::Version $LOCAL_VERSION is ready to publish! Run: git tag v$LOCAL_VERSION && git push origin v$LOCAL_VERSION"
                echo "New version detected ($LOCAL_VERSION > $REMOTE_VERSION)."
                echo "Please create and push a git tag 'v$LOCAL_VERSION' to trigger publishing."
             fi
          fi

  publish:
    name: Publish to pub.dev (On Tag)
    needs: test
    if: startsWith(github.ref, 'refs/tags/v') # Only run on tags
    runs-on: ubuntu-latest
    permissions:
      id-token: write # Required for authenticating with pub.dev OIDC
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Publish to pub.dev
        run: dart pub publish -f
